{% extends "base_authenticated.html" %}

{% block title %}Conversation with {{ contact.first_name }}{% endblock %}

{% block content %}
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold">Conversation with {{ contact.first_name }} {{ contact.last_name }}</h1>
            <p class="text-gray-400">{{ contact.phone }} ‚Ä¢ {{ contact.email or 'No email' }}</p>
            <a href="{{ url_for('contact.contact_detail', contact_id=contact.id) }}" class="text-sm text-blue-400 hover:text-blue-300">&larr; Back to Contact Details</a>
        </div>
        <div class="text-right text-sm text-gray-400">
            <p>{{ activities|length }} total activities</p>
            <p>Messages: {{ activities|selectattr('activity_type', 'equalto', 'message')|list|length }}</p>
            <p>Calls: {{ activities|selectattr('activity_type', 'equalto', 'call')|list|length }}</p>
        </div>
    </div>

    <div class="bg-gray-900 rounded-lg shadow">
        <!-- Timeline Container -->
        <div id="timeline-container" class="p-6 h-[70vh] overflow-y-auto space-y-4">
            
            {% for activity in activities %}
                
                <!-- MESSAGE ACTIVITY -->
                {% if activity.activity_type == 'message' %}
                    {% if activity.direction == 'outgoing' %}
                    <!-- Outgoing Message -->
                    <div class="flex justify-end">
                        <div class="bg-blue-600 text-white p-4 rounded-lg max-w-lg shadow-lg">
                            <div class="flex items-start space-x-2">
                                <div class="flex-1">
                                    {% if activity.body %}
                                        <p class="whitespace-pre-wrap">{{ activity.body }}</p>
                                    {% endif %}
                                    
                                    <!-- Media Attachments -->
                                    {% if activity.media_attachments %}
                                        <div class="mt-3 space-y-2">
                                            {% for media in activity.media_attachments %}
                                                {% if media.content_type and media.content_type.startswith('image/') %}
                                                    <img src="{{ media.source_url }}" alt="Attached image" class="rounded-lg max-w-xs cursor-pointer hover:opacity-90" onclick="window.open('{{ media.source_url }}', '_blank')">
                                                {% elif media.source_url %}
                                                    <div class="bg-blue-700 rounded p-2">
                                                        <a href="{{ media.source_url }}" target="_blank" class="text-blue-200 hover:text-white text-sm">
                                                            üìé Attachment ({{ media.content_type or 'Unknown type' }})
                                                        </a>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- JSON media URLs (fallback) -->
                                    {% if activity.media_urls %}
                                        <div class="mt-3 space-y-2">
                                            {% for media_url in activity.media_urls %}
                                                <div class="bg-blue-700 rounded p-2">
                                                    <a href="{{ media_url }}" target="_blank" class="text-blue-200 hover:text-white text-sm">
                                                        üìé Media Attachment
                                                    </a>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="text-blue-200">
                                    <span class="text-xs">‚úì</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-2 text-xs text-blue-200">
                                <span>{{ activity.status or 'sent' }}</span>
                                <span>{{ activity.created_at.strftime('%b %d, %I:%M %p') }}</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Incoming Message -->
                    <div class="flex justify-start">
                        <div class="bg-gray-700 text-white p-4 rounded-lg max-w-lg shadow-lg">
                            {% if activity.body %}
                                <p class="whitespace-pre-wrap">{{ activity.body }}</p>
                            {% endif %}
                            
                            <!-- Media Attachments -->
                            {% if activity.media_attachments %}
                                <div class="mt-3 space-y-2">
                                    {% for media in activity.media_attachments %}
                                        {% if media.content_type and media.content_type.startswith('image/') %}
                                            <img src="{{ media.source_url }}" alt="Attached image" class="rounded-lg max-w-xs cursor-pointer hover:opacity-90" onclick="window.open('{{ media.source_url }}', '_blank')">
                                        {% elif media.source_url %}
                                            <div class="bg-gray-600 rounded p-2">
                                                <a href="{{ media.source_url }}" target="_blank" class="text-gray-200 hover:text-white text-sm">
                                                    üìé Attachment ({{ media.content_type or 'Unknown type' }})
                                                </a>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- JSON media URLs (fallback) -->
                            {% if activity.media_urls %}
                                <div class="mt-3 space-y-2">
                                    {% for media_url in activity.media_urls %}
                                        <div class="bg-gray-600 rounded p-2">
                                            <a href="{{ media_url }}" target="_blank" class="text-gray-200 hover:text-white text-sm">
                                                üìé Media Attachment
                                            </a>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                                <span>{{ activity.status or 'received' }}</span>
                                <span>{{ activity.created_at.strftime('%b %d, %I:%M %p') }}</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                <!-- CALL ACTIVITY -->
                {% elif activity.activity_type == 'call' %}
                <div class="flex justify-center my-6">
                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-4 max-w-md w-full">
                        <div class="text-center">
                            <!-- Call Icon and Basic Info -->
                            <div class="flex items-center justify-center space-x-2 mb-3">
                                {% if activity.direction == 'incoming' %}
                                    <span class="text-green-400 text-xl">üìû</span>
                                    <span class="text-green-400 font-semibold">Incoming Call</span>
                                {% else %}
                                    <span class="text-blue-400 text-xl">üìû</span>
                                    <span class="text-blue-400 font-semibold">Outgoing Call</span>
                                {% endif %}
                            </div>
                            
                            <!-- Call Status and Duration -->
                            <div class="text-sm text-gray-300 mb-2">
                                <p><strong>Status:</strong> {{ activity.status or 'completed' }}</p>
                                {% if activity.duration_seconds %}
                                    <p><strong>Duration:</strong> {{ '%02d:%02d' % (activity.duration_seconds // 60, activity.duration_seconds % 60) }}</p>
                                {% endif %}
                                <p><strong>Time:</strong> {{ activity.created_at.strftime('%b %d, %Y at %I:%M %p') }}</p>
                            </div>
                            
                            <!-- Call Recording -->
                            {% if activity.recording_url %}
                                <div class="mt-4 p-3 bg-gray-700 rounded-lg">
                                    <p class="text-sm text-gray-300 mb-2">üéµ Call Recording</p>
                                    <audio controls class="w-full">
                                        <source src="{{ activity.recording_url }}" type="audio/mpeg">
                                        <source src="{{ activity.recording_url }}" type="audio/wav">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            {% endif %}
                            
                            <!-- Voicemail -->
                            {% if activity.voicemail_url %}
                                <div class="mt-4 p-3 bg-gray-700 rounded-lg">
                                    <p class="text-sm text-gray-300 mb-2">üìß Voicemail</p>
                                    <audio controls class="w-full">
                                        <source src="{{ activity.voicemail_url }}" type="audio/mpeg">
                                        <source src="{{ activity.voicemail_url }}" type="audio/wav">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            {% endif %}
                            
                            <!-- AI Summary -->
                            {% if activity.ai_summary %}
                                <div class="mt-4 p-3 bg-purple-900 bg-opacity-50 rounded-lg text-left">
                                    <p class="text-sm text-purple-200 mb-2">ü§ñ AI Call Summary</p>
                                    <div class="text-sm text-gray-200 whitespace-pre-wrap">{{ activity.ai_summary }}</div>
                                </div>
                            {% endif %}
                            
                            <!-- AI Next Steps -->
                            {% if activity.ai_next_steps %}
                                <div class="mt-3 p-3 bg-blue-900 bg-opacity-50 rounded-lg text-left">
                                    <p class="text-sm text-blue-200 mb-2">üìã Next Steps</p>
                                    <div class="text-sm text-gray-200 whitespace-pre-wrap">{{ activity.ai_next_steps }}</div>
                                </div>
                            {% endif %}
                            
                            <!-- AI Transcript -->
                            {% if activity.ai_transcript and activity.ai_transcript.dialogue %}
                                <div class="mt-4 p-3 bg-gray-700 rounded-lg text-left">
                                    <p class="text-sm text-gray-300 mb-2">üìù Call Transcript</p>
                                    <div class="max-h-40 overflow-y-auto space-y-1 text-xs">
                                        {% for segment in activity.ai_transcript.dialogue %}
                                            <div class="flex">
                                                <span class="font-semibold text-gray-400 w-16 flex-shrink-0">
                                                    {{ segment.speaker or 'Unknown' }}:
                                                </span>
                                                <span class="text-gray-200 flex-1">{{ segment.text or segment.content }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- UNKNOWN ACTIVITY TYPE -->
                {% else %}
                <div class="flex justify-center">
                    <div class="bg-gray-800 rounded-lg p-3 text-center text-gray-400">
                        <p class="text-sm">{{ activity.activity_type or 'Unknown' }} activity</p>
                        <p class="text-xs">{{ activity.created_at.strftime('%b %d, %I:%M %p') }}</p>
                    </div>
                </div>
                {% endif %}

            {% else %}
                <div class="text-center text-gray-400 py-8">
                    <p>No activities found for this contact.</p>
                    <p class="text-sm mt-2">Start a conversation by sending a message below.</p>
                </div>
            {% endfor %}
        </div>

        <!-- Message Composition Form -->
        <div class="p-4 border-t border-gray-700 bg-gray-800">
            <form method="POST" class="space-y-3">
                <div class="flex items-center space-x-2">
                    <input type="text" name="body" placeholder="Type your message..." autocomplete="off" required 
                           class="flex-grow bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                        <span>Send</span>
                        <span>üì§</span>
                    </button>
                </div>
                <div class="text-xs text-gray-500 text-center">
                    Messages will be sent via OpenPhone to {{ contact.phone }}
                </div>
            </form>
        </div>
    </div>

    <!-- Auto-scroll to bottom script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const timeline = document.getElementById('timeline-container');
            timeline.scrollTop = timeline.scrollHeight;
        });
    </script>
{% endblock %}