{% extends "base.html" %}
{% block title %}OpenPhone Reconciliation{% endblock %}

{% block content %}
<div class="container mx-auto px-8 py-8">
    <div class="bg-gray-800 p-6 rounded-lg">
        <h1 class="text-2xl font-bold text-white mb-6">OpenPhone Data Reconciliation</h1>
        
        <!-- Status Card -->
        <div class="bg-gray-700 p-4 rounded mb-6">
            <h2 class="text-lg font-semibold text-white mb-3">Current Status</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <p class="text-gray-400 text-sm">Last Run</p>
                    <p class="text-white">
                        {% if stats.last_run %}
                            {{ stats.last_run.strftime('%Y-%m-%d %H:%M:%S') if stats.last_run else 'Never' }}
                        {% else %}
                            Never
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Total Processed</p>
                    <p class="text-white">{{ stats.total_processed or 0 }}</p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Total Errors</p>
                    <p class="text-white">{{ stats.total_errors or 0 }}</p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Runs Today</p>
                    <p class="text-white">{{ stats.runs_today or 0 }}</p>
                </div>
            </div>
            {% if stats.last_error %}
            <div class="mt-4 p-3 bg-red-900 rounded">
                <p class="text-red-300 text-sm">Last Error:</p>
                <p class="text-white text-sm">{{ stats.last_error }}</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Manual Reconciliation -->
        <div class="bg-gray-700 p-4 rounded mb-6">
            <h2 class="text-lg font-semibold text-white mb-3">Manual Reconciliation</h2>
            <form id="reconciliation-form" method="POST" action="{{ url_for('reconciliation.run_reconciliation') }}">
                <div class="flex items-end gap-4">
                    <div class="flex-1">
                        <label for="hours_back" class="block text-gray-400 text-sm mb-1">Hours to Look Back</label>
                        <input type="number" id="hours_back" name="hours_back" value="24" min="1" max="168"
                               class="w-full bg-gray-600 text-white px-3 py-2 rounded">
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                        Run Reconciliation
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Data Integrity -->
        <div class="bg-gray-700 p-4 rounded">
            <h2 class="text-lg font-semibold text-white mb-3">Data Integrity</h2>
            <p class="text-gray-400 mb-4">Validate data consistency between OpenPhone and local database.</p>
            <button id="validate-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
                Run Validation
            </button>
        </div>
        
        <!-- Schedule Info -->
        <div class="mt-6 p-4 bg-gray-900 rounded">
            <h3 class="text-white font-semibold mb-2">Automatic Schedule</h3>
            <ul class="text-gray-400 text-sm space-y-1">
                <li>• Daily reconciliation runs at 2:00 AM UTC (last 48 hours)</li>
                <li>• Weekly data integrity check runs Sunday at 3:00 AM UTC</li>
            </ul>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle reconciliation form submission
    document.getElementById('reconciliation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Running...';
        
        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Reconciliation started successfully. Task ID: ' + data.task_id);
                // Refresh page after a delay
                setTimeout(() => location.reload(), 2000);
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Failed to start reconciliation: ' + error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
    
    // Handle validation button
    document.getElementById('validate-btn').addEventListener('click', async function() {
        const originalText = this.textContent;
        this.disabled = true;
        this.textContent = 'Running...';
        
        try {
            const response = await fetch('{{ url_for("reconciliation.validate_integrity") }}', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Validation started. Task ID: ' + data.task_id);
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Failed to start validation: ' + error);
        } finally {
            this.disabled = false;
            this.textContent = originalText;
        }
    });
});
</script>
{% endblock %}