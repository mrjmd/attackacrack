{% extends "base_authenticated.html" %}

{% block title %}New Campaign{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <div class="bg-gray-700 rounded-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-white">Create New Campaign</h1>
                <p class="text-gray-400 mt-1">Build your next marketing campaign</p>
            </div>
            <a href="{{ url_for('campaigns.campaign_list') }}" class="text-gray-400 hover:text-white">
                ‚Üê Back to Campaigns
            </a>
        </div>

        <form method="POST" action="{{ url_for('campaigns.create_campaign') }}" id="campaignForm" class="space-y-6">
            <!-- Channel Selection -->
            <div class="bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-4">
                <label class="block text-sm font-medium text-blue-300 mb-3">
                    Campaign Channel <span class="text-red-400">*</span>
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="relative">
                        <input type="radio" name="channel" value="sms" checked class="sr-only">
                        <div class="border-2 border-blue-500 bg-blue-600 bg-opacity-20 rounded-lg p-4 cursor-pointer text-center">
                            <span class="text-2xl mb-2 block">üì±</span>
                            <h3 class="font-semibold text-white">Text Messages</h3>
                            <p class="text-sm text-blue-300 mt-1">SMS campaigns via OpenPhone</p>
                        </div>
                    </label>
                    <label class="relative opacity-50">
                        <input type="radio" name="channel" value="email" disabled class="sr-only">
                        <div class="border-2 border-gray-500 bg-gray-600 bg-opacity-20 rounded-lg p-4 cursor-not-allowed text-center">
                            <span class="text-2xl mb-2 block">üìß</span>
                            <h3 class="font-semibold text-gray-300">Email Campaigns</h3>
                            <p class="text-sm text-gray-400 mt-1">Coming soon with SmartLead integration</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Campaign Basic Info -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-300 mb-2">
                    Campaign Name <span class="text-red-400">*</span>
                </label>
                <input type="text" name="name" id="name" required 
                       class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white placeholder-gray-400"
                       placeholder="e.g., Spring Cleaning Outreach">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="campaign_type" class="block text-sm font-medium text-gray-300 mb-2">
                        Campaign Type <span class="text-red-400">*</span>
                    </label>
                    <select name="campaign_type" id="campaign_type" required 
                            class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white">
                        <option value="blast">Blast Campaign (Single message)</option>
                        <option value="ab_test">A/B Test Campaign</option>
                        <option value="automated">Automated Campaign</option>
                    </select>
                </div>
                <div>
                    <label for="audience_type" class="block text-sm font-medium text-gray-300 mb-2">
                        Audience Type
                    </label>
                    <select name="audience_type" id="audience_type" 
                            class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white">
                        <option value="mixed">Mixed (Cold + Customers)</option>
                        <option value="cold">Cold Prospects Only</option>
                        <option value="customer">Existing Customers Only</option>
                    </select>
                </div>
            </div>

            <!-- Message Templates -->
            <div>
                <label for="template_a" class="block text-sm font-medium text-gray-300 mb-2">
                    Message Template <span class="text-red-400">*</span>
                </label>
                <textarea name="template_a" id="template_a" rows="4" required
                          class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white placeholder-gray-400"
                          placeholder="Hi {first_name}, we're offering professional services in {neighborhood}. Would you like a free estimate? Reply STOP to opt out."></textarea>
                <p class="text-sm text-gray-400 mt-1">
                    Available variables: {first_name}, {last_name}, {email}, {company}, {neighborhood}
                </p>
            </div>

            <!-- A/B Test Template B (Hidden by default) -->
            <div id="template_b_group" class="hidden">
                <label for="template_b" class="block text-sm font-medium text-gray-300 mb-2">
                    Alternative Message (Variant B)
                </label>
                <textarea name="template_b" id="template_b" rows="4"
                          class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white placeholder-gray-400"
                          placeholder="Hello {first_name}! Looking for quality services in {neighborhood}? Get your free quote today! Text STOP to unsubscribe."></textarea>
            </div>

            <!-- Campaign Settings -->
            <div class="border-t border-gray-600 pt-6">
                <h2 class="text-lg font-semibold text-white mb-4">Campaign Settings</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="daily_limit" class="block text-sm font-medium text-gray-300 mb-2">
                            Daily Send Limit
                        </label>
                        <input type="number" name="daily_limit" id="daily_limit" 
                               value="125" min="1" max="500"
                               class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white">
                        <p class="text-sm text-gray-400 mt-1">Maximum messages per day (125 recommended for cold outreach)</p>
                    </div>
                    <div>
                        <label for="min_days_since_contact" class="block text-sm font-medium text-gray-300 mb-2">
                            Days Since Last Contact
                        </label>
                        <input type="number" name="min_days_since_contact" id="min_days_since_contact" 
                               value="30" min="1"
                               class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white">
                        <p class="text-sm text-gray-400 mt-1">Only contact people not texted in X days</p>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="business_hours_only" id="business_hours_only" checked
                               class="mr-3 rounded bg-gray-600 border-gray-500">
                        <span class="text-gray-300">Send only during business hours (9 AM - 6 PM ET, weekdays)</span>
                    </label>
                </div>
            </div>

            <!-- Audience Selection -->
            <div class="border-t border-gray-600 pt-6">
                <h2 class="text-lg font-semibold text-white mb-4">Audience Selection</h2>
                
                <!-- List or Filter Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">How to Select Recipients</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center bg-gray-600 rounded-lg p-3 cursor-pointer hover:bg-gray-500">
                            <input type="radio" name="audience_method" value="list" id="use_list_radio"
                                   class="mr-3 rounded bg-gray-700 border-gray-500">
                            <span class="text-white">Use Campaign List</span>
                        </label>
                        <label class="flex items-center bg-gray-600 rounded-lg p-3 cursor-pointer hover:bg-gray-500">
                            <input type="radio" name="audience_method" value="filters" id="use_filters_radio" checked
                                   class="mr-3 rounded bg-gray-700 border-gray-500">
                            <span class="text-white">Use Filters</span>
                        </label>
                    </div>
                </div>
                
                <!-- Campaign List Selection (hidden by default) -->
                <div id="list_selection" class="hidden mb-4">
                    <label for="list_id" class="block text-sm font-medium text-gray-300 mb-2">
                        Select Campaign List
                    </label>
                    <select name="list_id" id="list_id" 
                            class="w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-white">
                        <option value="">Choose a list...</option>
                        {% for list in campaign_lists %}
                            <option value="{{ list.id }}" data-count="{{ list.active_members_count }}">
                                {{ list.name }} ({{ list.active_members_count }} contacts)
                                {% if list.is_dynamic %}[Dynamic]{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="text-sm text-gray-400 mt-1">
                        <a href="{{ url_for('campaigns.campaign_lists') }}" class="text-blue-400 hover:text-blue-300">Manage Lists</a> |
                        <a href="{{ url_for('campaigns.new_campaign_list') }}" class="text-blue-400 hover:text-blue-300">Create New List</a>
                    </p>
                    <input type="hidden" name="use_list" id="use_list" value="off">
                </div>
                
                <!-- Filter Options (shown by default) -->
                <div id="filter_options" class="space-y-3">
                    <label class="flex items-center">
                        <input type="checkbox" name="has_name_only" id="has_name_only" checked
                               class="mr-3 rounded bg-gray-600 border-gray-500">
                        <span class="text-gray-300">Only contacts with real names (exclude phone numbers as names)</span>
                    </label>

                    <label class="flex items-center">
                        <input type="checkbox" name="has_email" id="has_email"
                               class="mr-3 rounded bg-gray-600 border-gray-500">
                        <span class="text-gray-300">Only contacts with email addresses</span>
                    </label>

                    <label class="flex items-center">
                        <input type="checkbox" name="exclude_office_numbers" id="exclude_office_numbers" checked
                               class="mr-3 rounded bg-gray-600 border-gray-500">
                        <span class="text-gray-300">Exclude office/business numbers</span>
                    </label>
                </div>
            </div>

            <!-- Audience Preview -->
            <div class="bg-blue-900 bg-opacity-50 border border-blue-700 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-blue-300 mb-3">Audience Size Preview</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                    <div>
                        <div class="text-2xl font-bold text-blue-400">{{ audience_stats.total_contacts }}</div>
                        <div class="text-sm text-gray-400">Total Contacts</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-400">{{ audience_stats.named_contacts }}</div>
                        <div class="text-sm text-gray-400">With Names</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-cyan-400">{{ audience_stats.email_contacts }}</div>
                        <div class="text-sm text-gray-400">With Emails</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-yellow-400">{{ audience_stats.opted_out_count }}</div>
                        <div class="text-sm text-gray-400">Opted Out</div>
                    </div>
                </div>
                <div class="text-center border-t border-blue-700 pt-3">
                    <span class="text-blue-300">Estimated Recipients: </span>
                    <span id="filtered_count" class="text-2xl font-bold text-blue-400">Calculating...</span>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-between pt-6">
                <a href="{{ url_for('campaigns.campaign_list') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                    ‚Üê Back to Campaigns
                </a>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                    üíæ Create Campaign
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const campaignTypeSelect = document.getElementById('campaign_type');
    const templateBGroup = document.getElementById('template_b_group');
    const templateB = document.getElementById('template_b');
    
    // Show/hide Template B based on campaign type
    campaignTypeSelect.addEventListener('change', function() {
        if (this.value === 'ab_test') {
            templateBGroup.classList.remove('hidden');
            templateB.required = true;
        } else {
            templateBGroup.classList.add('hidden');
            templateB.required = false;
        }
    });
    
    // Handle audience method selection
    const useListRadio = document.getElementById('use_list_radio');
    const useFiltersRadio = document.getElementById('use_filters_radio');
    const listSelection = document.getElementById('list_selection');
    const filterOptions = document.getElementById('filter_options');
    const useListInput = document.getElementById('use_list');
    const listIdSelect = document.getElementById('list_id');
    
    useListRadio.addEventListener('change', function() {
        if (this.checked) {
            listSelection.classList.remove('hidden');
            filterOptions.classList.add('hidden');
            useListInput.value = 'on';
            updateListPreview();
        }
    });
    
    useFiltersRadio.addEventListener('change', function() {
        if (this.checked) {
            listSelection.classList.add('hidden');
            filterOptions.classList.remove('hidden');
            useListInput.value = 'off';
            updateAudiencePreview();
        }
    });
    
    // Update preview when list is selected
    listIdSelect.addEventListener('change', updateListPreview);
    
    function updateListPreview() {
        const selectedOption = listIdSelect.options[listIdSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            const count = selectedOption.getAttribute('data-count') || '0';
            document.getElementById('filtered_count').textContent = parseInt(count).toLocaleString();
        } else {
            document.getElementById('filtered_count').textContent = '0';
        }
    }
    
    // Update audience preview when filters change
    const filterInputs = document.querySelectorAll('#has_name_only, #has_email, #exclude_office_numbers, #min_days_since_contact');
    
    function updateAudiencePreview() {
        // Only update if using filters
        if (!useFiltersRadio.checked) return;
        
        const filters = {
            has_name_only: document.getElementById('has_name_only').checked,
            has_email: document.getElementById('has_email').checked,
            exclude_office_numbers: document.getElementById('exclude_office_numbers').checked,
            min_days_since_contact: parseInt(document.getElementById('min_days_since_contact').value) || 30
        };
        
        fetch('{{ url_for("campaigns.api_preview_audience") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('filtered_count').textContent = data.audience_size.toLocaleString();
            } else {
                document.getElementById('filtered_count').textContent = 'Error calculating';
            }
        })
        .catch(error => {
            document.getElementById('filtered_count').textContent = 'Error calculating';
        });
    }
    
    // Initial audience preview
    updateAudiencePreview();
    
    // Update on filter changes
    filterInputs.forEach(input => {
        input.addEventListener('change', updateAudiencePreview);
    });
});
</script>
{% endblock %}