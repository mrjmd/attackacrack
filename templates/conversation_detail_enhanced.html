{% extends "base.html" %}

{% block title %}Conversation - {{ contact.first_name }} {{ contact.last_name }}{% endblock %}

{% block content %}
<div class="flex h-screen">
    <!-- Left Sidebar: Contact Information -->
    <div class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
        <!-- Contact Header -->
        <div class="p-6 border-b border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Contact Info</h2>
                <a href="{{ url_for('contact.contact_detail', contact_id=contact.id) }}" 
                   class="text-sm text-blue-400 hover:text-blue-300">
                    View Full Profile ‚Üí
                </a>
            </div>
            
            <!-- Contact Basic Info -->
            <div class="space-y-3">
                <div>
                    <h3 class="text-2xl font-semibold text-white">
                        {{ contact.first_name }} {{ contact.last_name }}
                    </h3>
                    {% if contact.email %}
                    <p class="text-gray-400 text-sm">{{ contact.email }}</p>
                    {% endif %}
                </div>
                
                <div class="flex items-center gap-2 text-gray-300">
                    <span>üì±</span>
                    <span>{{ contact.phone }}</span>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex gap-2 pt-3">
                    <button class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                        üìû Call
                    </button>
                    <button class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm">
                        üìß Email
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Contact Details -->
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- Customer Status -->
            {% if contact.quickbooks_customer_id %}
            <div class="bg-green-900 bg-opacity-30 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-green-400 mb-2">‚úì QuickBooks Customer</h4>
                <div class="text-sm text-gray-300 space-y-1">
                    <p>Total Sales: ${{ contact.total_sales|default(0)|int }}</p>
                    <p>Outstanding: ${{ contact.outstanding_balance|default(0)|int }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Properties -->
            {% if contact.properties %}
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-2">Properties</h4>
                <div class="space-y-2">
                    {% for property in contact.properties[:3] %}
                    <div class="bg-gray-700 rounded p-3">
                        <p class="text-sm text-white">{{ property.address }}</p>
                        <p class="text-xs text-gray-400">{{ property.jobs|length }} jobs</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Recent Jobs -->
            {% if recent_jobs %}
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-2">Recent Jobs</h4>
                <div class="space-y-2">
                    {% for job in recent_jobs[:3] %}
                    <div class="bg-gray-700 rounded p-3">
                        <p class="text-sm text-white">{{ job.description }}</p>
                        <p class="text-xs text-gray-400">
                            {% if job.completed_at %}{{ job.completed_at.strftime('%b %d, %Y') }}{% else %}In Progress{% endif %} - {{ job.status }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Tags & Flags -->
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-2">Tags & Status</h4>
                <div class="flex flex-wrap gap-2">
                    {% if contact.contact_metadata and contact.contact_metadata.get('tags') %}
                        {% for tag in contact.contact_metadata.get('tags', []) %}
                        <span class="px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs">{{ tag }}</span>
                        {% endfor %}
                    {% endif %}
                    {% if has_office_flag %}
                    <span class="px-2 py-1 bg-yellow-900 text-yellow-300 rounded text-xs">üè¢ Office</span>
                    {% endif %}
                    {% if has_opted_out %}
                    <span class="px-2 py-1 bg-red-900 text-red-300 rounded text-xs">üö´ Opted Out</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Campaign History -->
            {% if campaign_memberships %}
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-2">Campaign History</h4>
                <div class="space-y-2">
                    {% for membership in campaign_memberships[:3] %}
                    <div class="bg-gray-700 rounded p-3">
                        <p class="text-sm text-white">{{ membership.campaign.name }}</p>
                        <p class="text-xs text-gray-400">
                            {{ membership.status }} - {{ membership.sent_at.strftime('%b %d') if membership.sent_at else 'Pending' }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Notes Section -->
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-2">Notes</h4>
                <textarea class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm text-white placeholder-gray-400 h-24"
                          placeholder="Add notes about this contact..."></textarea>
                <button class="mt-2 bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm">
                    Save Note
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content: Conversation -->
    <div class="flex-1 flex flex-col bg-gray-900">
        <!-- Conversation Header -->
        <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="{{ url_for('contact.conversation_list') }}" 
                       class="text-gray-400 hover:text-white">
                        ‚Üê Back
                    </a>
                    <div>
                        <h1 class="text-xl font-semibold text-white">
                            {{ contact.first_name }} {{ contact.last_name }}
                        </h1>
                        <div class="flex items-center gap-4 text-sm text-gray-400">
                            <span>{{ activities|length }} messages</span>
                            <span>{{ call_count }} calls</span>
                            {% if last_activity_date %}
                            <span>Last activity: {{ last_activity_date }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Conversation Actions -->
                <div class="flex items-center gap-2">
                    <button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded" title="Search">
                        üîç
                    </button>
                    <button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded" title="Add to Campaign">
                        üì¢
                    </button>
                    <button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded" title="Schedule">
                        üìÖ
                    </button>
                    <button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded" title="More">
                        ‚ãÆ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Messages Container -->
        <div id="messages-container" class="flex-1 overflow-y-auto px-6 py-4 space-y-6">
            <!-- Date Separators and Messages -->
            {% set current_date = None %}
            {% for activity in activities %}
                {% set activity_date = activity.created_at.date() %}
                
                <!-- Date Separator -->
                {% if activity_date != current_date %}
                    {% set current_date = activity_date %}
                    <div class="flex items-center justify-center my-6">
                        <div class="bg-gray-800 rounded-full px-4 py-1 text-sm text-gray-400">
                            {{ activity.created_at.strftime('%B %d, %Y') }}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Message/Activity Display -->
                {% if activity.activity_type == 'message' %}
                    <div class="flex {% if activity.direction == 'outgoing' %}justify-end{% else %}justify-start{% endif %}">
                        <div class="max-w-2xl">
                            <div class="{% if activity.direction == 'outgoing' %}bg-blue-600 text-white{% else %}bg-gray-700 text-white{% endif %} rounded-lg px-4 py-3 shadow-lg">
                                <!-- Message Content -->
                                {% if activity.body %}
                                    <p class="whitespace-pre-wrap">{{ activity.body }}</p>
                                {% endif %}
                                
                                <!-- Media Attachments -->
                                {% if activity.media_urls %}
                                    {# Collect all image URLs for this message #}
                                    {% set image_urls = [] %}
                                    {% for media_item in activity.media_urls %}
                                        {% set is_image = false %}
                                        {% set media_url = None %}
                                        
                                        {% if media_item is string %}
                                            {% set media_url = media_item %}
                                            {# Check by file extension for legacy data #}
                                            {% if media_url.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                                {% set is_image = true %}
                                            {% endif %}
                                        {% elif media_item is mapping and 'url' in media_item %}
                                            {% set media_url = media_item.url %}
                                            {# Check by MIME type for new data #}
                                            {% if media_item.type and media_item.type.startswith('image/') %}
                                                {% set is_image = true %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if media_url and is_image %}
                                            {% set _ = image_urls.append(media_url) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <div class="mt-3 {% if image_urls|length > 1 %}grid grid-cols-2 gap-2{% endif %}">
                                        {% for media_item in activity.media_urls %}
                                            {% set is_image = false %}
                                            {% set media_url = None %}
                                            {% set media_type = None %}
                                            
                                            {% if media_item is string %}
                                                {% set media_url = media_item %}
                                                {# Check by file extension for legacy data #}
                                                {% if media_url.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                                    {% set is_image = true %}
                                                {% endif %}
                                            {% elif media_item is mapping and 'url' in media_item %}
                                                {% set media_url = media_item.url %}
                                                {% set media_type = media_item.type %}
                                                {# Check by MIME type for new data #}
                                                {% if media_type and media_type.startswith('image/') %}
                                                    {% set is_image = true %}
                                                {% endif %}
                                            {% endif %}
                                            
                                            {% if media_url %}
                                                {% if is_image %}
                                                    <div class="relative group">
                                                        <img src="{{ media_url }}" 
                                                             alt="Attached image" 
                                                             class="w-full h-48 object-cover rounded cursor-pointer transition-opacity group-hover:opacity-90"
                                                             onclick="openMediaModal('{{ media_url }}', {{ image_urls|tojson }})">
                                                        {% if image_urls|length > 1 %}
                                                            <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                                                                {{ loop.index }} / {{ image_urls|length }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <a href="{{ media_url }}" target="_blank" 
                                                       class="block bg-black bg-opacity-20 rounded p-3 hover:bg-opacity-30 transition-colors">
                                                        <span class="text-sm">üìé Attachment</span>
                                                    </a>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Message Metadata -->
                            <div class="flex items-center gap-2 mt-1 px-1 text-xs text-gray-500">
                                <span>{{ activity.created_at.strftime('%I:%M %p') }}</span>
                                {% if activity.direction == 'outgoing' %}
                                    <span>‚Ä¢</span>
                                    <span>{{ activity.status|default('sent')|title }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                {% elif activity.activity_type == 'call' %}
                    <!-- Enhanced Call Display -->
                    <div class="flex justify-center my-6">
                        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full border border-gray-700">
                            <div class="flex items-start gap-4">
                                <div class="text-3xl">
                                    {% if activity.direction == 'incoming' %}
                                        <span class="text-green-400">üìû</span>
                                    {% else %}
                                        <span class="text-blue-400">üìû</span>
                                    {% endif %}
                                </div>
                                
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-white mb-2">
                                        {{ 'Incoming' if activity.direction == 'incoming' else 'Outgoing' }} Call
                                    </h3>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-400">Status:</span>
                                            <span class="text-white ml-2">{{ activity.status|default('completed')|title }}</span>
                                        </div>
                                        {% if activity.duration_seconds %}
                                        <div>
                                            <span class="text-gray-400">Duration:</span>
                                            <span class="text-white ml-2">{{ (activity.duration_seconds // 60) }}m {{ (activity.duration_seconds % 60) }}s</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Recording Player -->
                                    {% if activity.recording_url %}
                                    <div class="mt-4 bg-gray-900 rounded-lg p-4">
                                        <p class="text-sm text-gray-400 mb-2">üìº Call Recording</p>
                                        <audio controls class="w-full">
                                            <source src="{{ activity.recording_url }}" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- AI Summary -->
                                    {% if activity.ai_summary %}
                                    <div class="mt-4 bg-purple-900 bg-opacity-20 rounded-lg p-4 border border-purple-800">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-purple-400">ü§ñ</span>
                                            <h4 class="text-sm font-semibold text-purple-300">AI Summary</h4>
                                        </div>
                                        <p class="text-sm text-gray-200 whitespace-pre-wrap">{{ activity.ai_summary }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Next Steps -->
                                    {% if activity.ai_next_steps %}
                                    <div class="mt-3 bg-blue-900 bg-opacity-20 rounded-lg p-4 border border-blue-800">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-blue-400">üìã</span>
                                            <h4 class="text-sm font-semibold text-blue-300">Recommended Actions</h4>
                                        </div>
                                        <p class="text-sm text-gray-200 whitespace-pre-wrap">{{ activity.ai_next_steps }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Expandable Transcript -->
                                    {% if activity.ai_transcript and activity.ai_transcript.dialogue %}
                                    <details class="mt-4">
                                        <summary class="cursor-pointer text-sm text-gray-400 hover:text-white">
                                            üìù View Full Transcript ({{ activity.ai_transcript.dialogue|length }} lines)
                                        </summary>
                                        <div class="mt-3 bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto">
                                            <div class="space-y-2 text-sm">
                                                {% for segment in activity.ai_transcript.dialogue %}
                                                <div class="flex gap-3">
                                                    <span class="font-semibold text-gray-400 w-20 flex-shrink-0">
                                                        {{ segment.speaker|default('Unknown') }}:
                                                    </span>
                                                    <span class="text-gray-200">{{ segment.text|default(segment.content) }}</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </details>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                {% elif activity.activity_type == 'voicemail' %}
                    <!-- Voicemail Display -->
                    <div class="flex justify-center my-6">
                        <div class="bg-gray-800 rounded-lg p-4 max-w-md w-full border border-gray-700">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-2xl text-orange-400">üé§</span>
                                <h3 class="text-lg font-semibold text-white">Voicemail</h3>
                            </div>
                            {% if activity.voicemail_url %}
                            <audio controls class="w-full">
                                <source src="{{ activity.voicemail_url }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            {% endif %}
                            <p class="text-xs text-gray-500 mt-2">{{ activity.created_at.strftime('%I:%M %p') }}</p>
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <p class="text-lg mb-2">No conversation history</p>
                        <p class="text-sm">Send a message to start the conversation</p>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Message Composer -->
        <div class="bg-gray-800 border-t border-gray-700 p-4">
            <form method="POST" action="{{ url_for('contact.send_message', contact_id=contact.id) }}" class="flex items-end gap-3">
                <div class="flex-1">
                    <textarea name="body" 
                              rows="1"
                              placeholder="Type a message..."
                              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                              onkeydown="handleKeyPress(event)"
                              oninput="autoResize(this)"></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="button" 
                            class="p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg"
                            title="Attach file">
                        üìé
                    </button>
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg flex items-center gap-2">
                        <span>Send</span>
                        <span>‚û§</span>
                    </button>
                </div>
            </form>
            <p class="text-xs text-gray-500 mt-2 text-center">
                Press Enter to send, Shift+Enter for new line
            </p>
        </div>
    </div>
</div>

<!-- Enhanced Media Modal with Slideshow -->
<div id="mediaModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4" onclick="closeMediaModal()">
    <div class="relative max-w-7xl max-h-full" onclick="event.stopPropagation()">
        <!-- Close button -->
        <button onclick="closeMediaModal()" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 z-10">√ó</button>
        
        <!-- Previous button -->
        <button id="prevButton" onclick="changeSlide(-1)" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white text-5xl hover:text-gray-300 z-10 hidden">
            ‚Äπ
        </button>
        
        <!-- Next button -->
        <button id="nextButton" onclick="changeSlide(1)" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white text-5xl hover:text-gray-300 z-10 hidden">
            ‚Ä∫
        </button>
        
        <!-- Image container -->
        <img id="modalImage" src="" alt="Full size image" class="max-w-full max-h-full">
        
        <!-- Image counter -->
        <div id="imageCounter" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white text-sm bg-black bg-opacity-50 px-3 py-1 rounded hidden">
            <span id="currentImageNum">1</span> / <span id="totalImageNum">1</span>
        </div>
    </div>
</div>

<script>
// Auto-scroll to bottom on load
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
});

// Auto-resize textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// Handle Enter key for sending
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        event.target.form.submit();
    }
}

// Media modal and slideshow functions
let currentImages = [];
let currentImageIndex = 0;

function openMediaModal(src, allImages) {
    // If allImages is provided, set up slideshow
    if (allImages && allImages.length > 0) {
        currentImages = allImages;
        currentImageIndex = allImages.indexOf(src);
        if (currentImageIndex === -1) currentImageIndex = 0;
        
        // Show/hide slideshow controls
        if (allImages.length > 1) {
            document.getElementById('prevButton').classList.remove('hidden');
            document.getElementById('nextButton').classList.remove('hidden');
            document.getElementById('imageCounter').classList.remove('hidden');
            updateImageCounter();
        } else {
            document.getElementById('prevButton').classList.add('hidden');
            document.getElementById('nextButton').classList.add('hidden');
            document.getElementById('imageCounter').classList.add('hidden');
        }
    } else {
        // Single image
        currentImages = [src];
        currentImageIndex = 0;
        document.getElementById('prevButton').classList.add('hidden');
        document.getElementById('nextButton').classList.add('hidden');
        document.getElementById('imageCounter').classList.add('hidden');
    }
    
    document.getElementById('modalImage').src = src;
    document.getElementById('mediaModal').classList.remove('hidden');
}

function closeMediaModal() {
    document.getElementById('mediaModal').classList.add('hidden');
    currentImages = [];
    currentImageIndex = 0;
}

function changeSlide(direction) {
    currentImageIndex += direction;
    
    // Wrap around
    if (currentImageIndex >= currentImages.length) {
        currentImageIndex = 0;
    } else if (currentImageIndex < 0) {
        currentImageIndex = currentImages.length - 1;
    }
    
    document.getElementById('modalImage').src = currentImages[currentImageIndex];
    updateImageCounter();
}

function updateImageCounter() {
    document.getElementById('currentImageNum').textContent = currentImageIndex + 1;
    document.getElementById('totalImageNum').textContent = currentImages.length;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (document.getElementById('mediaModal').classList.contains('hidden')) return;
    
    switch(e.key) {
        case 'Escape':
            closeMediaModal();
            break;
        case 'ArrowLeft':
            if (currentImages.length > 1) changeSlide(-1);
            break;
        case 'ArrowRight':
            if (currentImages.length > 1) changeSlide(1);
            break;
    }
});

// Real-time message updates
let lastActivityCount = {{ activities|length }};

function refreshMessages() {
    const contactId = {{ contact.id }};
    
    fetch(`/api/contacts/${contactId}/messages`)
        .then(response => response.json())
        .then(messages => {
            if (messages.length > lastActivityCount) {
                // New messages arrived, refresh the page to show them
                // In the future, we could append just the new messages
                window.location.reload();
            }
            lastActivityCount = messages.length;
        })
        .catch(error => console.error('Error checking for new messages:', error));
}

function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

// Check for new messages every 10 seconds
setInterval(refreshMessages, 10000);

// Also check when the page becomes visible again (user switches back to tab)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        refreshMessages();
    }
});
</script>
{% endblock %}